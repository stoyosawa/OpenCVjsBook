<!-- 仮題 -->
# OpenCV.js～クライアントサイドで実装できる画像・ビデオ処理Webアプリケーションの作成（仮題）

## はじめに

Web技術の進歩に伴い、たいていのことはWebアプリケーションで実行できるようになりました。しかし、ブラウザ（フロントエンド）ではできないこともあります。計算上困難なものであったり、JavaScriptやCSSだけで対処するのが難しいものは、今でもサーバ側で処理されます。機械学習（AI）を含む、画像や動画の処理などがその好例です。

そうした中、画像・ビデオ処理ライブラリの定番であるOpenCVが、ブラウザ環境で利用できるようになりました。JavaScript版なのでOpenCV.jsと呼ばれます。これで、これまではバックエンドに頼らざるをえなかった高度な画像処理技術がフロントエンドでも活用できます。OpenCV.jsを導入すれば、Webデザインやサービスの質と表現性がより高くなることが期待できます。

OpenCV（Open Source Computer Vision）は2000年に最初のバージョンがリリースされたコンピュータビジョン専門のプログラミングライブラリです。画像のリサイズや色調の調整などベーシックな機能に始まり、物体の自動認識やディープラーニングのような旬な先端技術もカバーしています。実装されているアルゴリズムの数は2000を超えます

本書ではこのOpenCV.jsの導入からOpenCVの基本までをサンプルコードとともに説明します。サンプルコードは全部で62本。短ければHTMLの部分も含めて最短で25行、最長で136行なので、学ぶのはそう難しくありません。OpenCVの基本説明に傾注したサンプルはややつまらないかもしれませんが、アプリケーションをイメージできる例題も多く用意しています。たとえば次のような題材です。

- マウスで描画できるお絵描きツールを作成する（[4.6節](./04-mat.html#46-お絵描きツールを作る "INTERNAL")）。
- 減色操作で画像をポスター化する（[5.6節](./05-img.html#56-ポスター化する "INTERNAL")）。
- 画像から線画を生成し、イラスト・アニメ絵風な着色をする（[6.3節](./06-img.html#63-画像から線画を起こす "INTERNAL")）。
- 画像中に埋まったQRコードを読み取る（[6.4節](./06-img.html#64-QRコードを読む "INTERNAL")）。
- スキャナーで傾いて取り込んだ画像をまっすぐにする（[6.6節](./06-img.html#66-書類の傾きを補正する "INTERNAL")）。
- 画像中の顔を、スマホカメラのように検出する（[6.7節](./06-img.html#67-顔を検出する "INTERNAL")）。
- 実写ビデオを特撮のセット撮影のようにミニチュア風に変換する（[7.3節](./07-video.html#73-実写をミニチュア風にする "INTERNAL")）。
- 固定カメラ中を移動する車両や歩行者だけを抽出する（[7.5節](./07-video.html#75-動いているものだけを抜き出す "INTERNAL")）。

本書では、最初の2章でOpenCV開発で必要になるHTML5の技術を説明します。`<img>`、`<video>`、`<canvas>`、`navigator.mediaDevices.getUserMedia()`、`HTMLVideoElement.requestVideoFrameCallback`などです。これら2章はOpenCVプログラマーがWeb開発をすることを念頭に用意したものです。Webフロントエンド開発にすでに従事している読者は第3章から読み始める、あるいはときおり参照するだけでも問題はありません。第3章ではOpenCV.jsの導入方法を説明し、以下、画像コンテナの`cv.Mat`、色操作、画像処理、ビデオ処理へと話を進めます。

本書を通じて、より豊かなWebエクスペリエンスを提供するアプリケーションの構築ができるようになることを期待しています。

2024年1月  
豊沢 聡


### 注意事項

以下、本書で注意すべき点を説明します。

#### 対象読者

本書は次の読者を対象としています。

- 画像処理をフロントエンドに導入するWeb開発者
- OpenCV技術をWebフロントエンドに導入する画像処理プログラマー
- JavaScriptの基礎を踏まえたうえで、画像処理に進むの専門課程の学生

本書は、読者諸氏がすでにHTML5（タグや属性など）とJavaScript（言語仕様、DOMオブジェクト、イベントハンドリングなど）についてある程度の知識と経験があることを前提にしています。ただ、`<img>`、`<video>`、描画コンテクスト（`CanvasRenderingContext2D`）など、画像・ビデオ処理と直接関係する部分は折に触れて説明します。

#### 実行環境

Web技術は基本的にブラウザやOSに依存しないので、開発・実行環境は問いません。新機能のなかにはブラウザ独自の仕様のものもありますが、それらは用いていません。

ただし、1点だけ、ビデオをフレーム単位で処理するメカニズムでブラウザ依存の仕様を使っています。具体的には、Firefoxでは`HTMLVideoElement.seekToNextFrame()`を、それ以外のブラウザでは`HTMLVideoElement.requestVideoFrameCallback()`をそれぞれ利用します。OpenCVでのビデオ処理はフレーム単位が基本なので、フレームに分解できなければ対応できないからです。詳細は[1.9節](./01-html5.md#19-ビデオをフレーム単位で取得する "INTERNAL")で説明します。[第7章](./07-video.md "INTERNAL")ではビデオを扱いますが、そこでは`HTMLVideoElement.requestVideoFrameCallback()`を使って実装しています。

センシティブな情報を頻繁に外部とやりとりするWeb環境では、一般的なアプリケーションよりセキュリティが厳しくなっています。たとえば、ローカルに置かれたHTMLページと画像を処理するといった、はた目には無害な操作ですら制約がかかっています。そのため、本書のコードはページ、画像、外部リソース（訓練データなど）はすべてWebサーバに置かれていると仮定しています（サーバはローカル運用でも、レンタルサーバでもかまいません）。ローカルファイルからでも実行できないわけではないですが、セキュリティ基準を下げる必要があります。これらについては[3.2節](./03-opencv.md#32-Cross-Originの問題を回避する "INTERNAL")で説明します。

#### サンプルスクリプト

本書のサンプルスクリプトはライブラリ化したJavaScriptファイル数点を除けば、すべてHTMLファイルです。OpenCVコードはその中の`<script></script>`に直接記述しているので、ほとんどのファイルは単体で動作します。コードはChromeとFirefoxでテストしており、とくに明示していなければ、掲載画面およびコンソール出力はChromeのものです。

スクリプトは出版社のダウンロードサービスからダウンロードできます。ダウンロードサービスには、実行例で用いたサンプル画像・ビデオ、顔認識で用いた訓練済みモデルデータ、リンク付きの参考文献（[付録A](./A-References.md "INTERNAL")）が含まれています。

サンプルスクリプトは目的を達成できる最小限で書かれています。例外にはほとんど対処しないので、エラー終了することもあります（たとえばハードコードしてある画像が見つからないなど）。

#### 実行例

> 色刷りなど構成は未定。

本書そのものはモノクロ印刷なので、カラーを対象にした処理例もモノクロで表示されています。モノクロではニュアンスの取れない実行例の画面は、脇に示したQRコードから出版社サイトにアクセスすることで閲覧できるようになっています。ご利用ください。

実行例で用いた画像・ビデオは、筆者作成の一部を除いて、いずれもPixabayから取得したものです。
