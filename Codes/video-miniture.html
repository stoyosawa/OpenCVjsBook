<!DOCTYPE html>
<html lang="ja-JP">
<head>
  <meta charset="UTF-8">
  <link rel=stylesheet type="text/css" href="style.css">
  <script async src="libs/opencv.js" type="text/javascript"></script>
</head>
<body>

<h1>写真をミニチュア風にする</h1>

<div>
  <video width="380" width="203" id="videoTag" controls src="samples/traffic.mp4"></video>
  <canvas id="canvasTag" class="placeholder"></canvas>
</div>
<div>
  鮮やかさ倍率（1～3）
  <input type="range" id="rangeTagS" min="1" max="3" step="0.2" value="1"/>
  <span id="spanTagS" class="currentValue">1</span><br/>
  　明るさ倍率（1～3）
  <input type="range" id="rangeTagV" min="1" max="3" step="0.2" value="1"/>
  <span id="spanTagV" class="currentValue">1</span><br/>
  　　スキップ（1～6）
  <input type="range" id="rangeTagG" min="1" max="6" value="1"/>
  <span id="spanTagG" class="currentValue">1</span>
</div>

<script>
  let videoElem = document.getElementById('videoTag');
  let rangeElemS = document.getElementById('rangeTagS');
  let rangeElemV = document.getElementById('rangeTagV');
  let rangeElemG = document.getElementById('rangeTagG');
  let spanElemS = document.getElementById('spanTagS');
  let spanElemV = document.getElementById('spanTagV');
  let spanElemG = document.getElementById('spanTagG');

  let cap;
  let src4, src3, dst, roi1, roi2, temp1, temp2;
  let mv;
  let rect;

  function brighter(src, scales=[1, 1, 1]) {
    temp1 = new cv.Mat();
    cv.cvtColor(src, temp1, cv.COLOR_RGB2HSV);
    cv.split(temp1, mv);

    for(let i=0; i<mv.size(); i++) {
      if (scales[i] != 1) {
        temp2 = mv.get(i)
        cv.addWeighted(temp2, scales[i], temp2, 0, 0, temp2);
        mv.set(i, temp2);
      }
    }
    cv.merge(mv, temp1);
    cv.cvtColor(temp1, src, cv.COLOR_HSV2RGB);
  }

  let counter = 0;
  function perFrame() {
    let saturation = Number(rangeElemS.value);
    let value = Number(rangeElemV.value);
    let gap = Number(rangeElemG.value);
    spanElemS.innerHTML = saturation;
    spanElemV.innerHTML = value;
    spanElemG.innerHTML = gap;

    if (counter % gap == 0)  {
      cap.read(src4);
      cv.cvtColor(src4, src3, cv.COLOR_RGBA2RGB);

      brighter(src3, [1, saturation, value]);
      cv.bilateralFilter(src3, temp1, 7, 150, 150, cv.BORDER_DEFAULT);
      cv.blur(temp1, dst, new cv.Size(7, 7));

      roi1 = src3.roi(rect);
      roi2 = dst.roi(rect);
      roi1.copyTo(roi2);

      cv.imshow('canvasTag', dst);
    }

    counter ++;
    videoElem.requestVideoFrameCallback(perFrame);
  }

  function videoStop() {
    console.log('Resource released.');
    [src4, src3, dst, roi1, roi2, temp1, temp2, mv].forEach(m => m.delete());
  }

  function videoReady() {
    console.log('Video started.');
    videoElem.width = videoElem.offsetWidth;
    videoElem.height = videoElem.offsetHeight;

    cap = new cv.VideoCapture(videoElem);
    src4 = new cv.Mat(videoElem.height, videoElem.width, cv.CV_8UC4);
    src3 = new cv.Mat(videoElem.height, videoElem.width, cv.CV_8UC3);
    dst = new cv.Mat();
    temp1 = new cv.Mat();
    temp2 = new cv.Mat();
    mv = new cv.MatVector;

    let ratio = 0.7;
    let w = Math.floor(videoElem.width * ratio);
    let h = Math.floor(videoElem.height * ratio);
    let x = Math.floor((videoElem.width - w) / 2);
    let y = Math.floor((videoElem.height - h) / 2);
    rect = new cv.Rect(x, y, w, h);
    roi1 = new cv.Mat(h, w, cv.CV_8UC4);
    roi2 = new cv.Mat(h, w, cv.CV_8UC4);

    perFrame();
  }

  function opencvReady() {
    videoElem.addEventListener('play', videoReady);
    videoElem.addEventListener('pause', videoStop);
  }

  var Module = {
    onRuntimeInitialized: opencvReady
  }
</script>

</body>
</html>
